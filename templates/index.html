<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tennis Court Finder - Vienna</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
               background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
               min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 30px; position: relative; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .user-menu { position: absolute; top: 0; right: 0; display: flex; align-items: center; gap: 10px; }
        .user-email { color: white; font-size: 14px; }
        .logout-btn { background: rgba(255,255,255,0.2); color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none; font-size: 14px; transition: background 0.3s; }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }
        .search-box { background: white; border-radius: 12px; padding: 30px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        input[type="text"] { flex: 1; padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px;
                            font-size: 16px; transition: border 0.3s; }
        input[type="text"]:focus { outline: none; border-color: #667eea; }
        button { background: #667eea; color: white; border: none; padding: 15px 40px;
                border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;
                transition: background 0.3s; }
        button:hover { background: #5568d3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .examples { color: #666; font-size: 14px; margin-top: 10px; }
        .loading { text-align: center; padding: 40px; color: #667eea; display: none; }
        .results { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                  display: none; }
        .result-header { border-bottom: 2px solid #e0e0e0; padding-bottom: 15px; margin-bottom: 20px; }
        .result-header h2 { color: #333; font-size: 1.8em; }
        .result-info { color: #666; margin-top: 5px; }
        .slot { background: #f8f9fa; border-left: 4px solid #667eea; padding: 15px;
               margin-bottom: 15px; border-radius: 8px; transition: transform 0.2s; }
        .slot:hover { transform: translateX(5px); }
        .slot.preferred { background: #fff3cd; border-left-color: #ffc107; }
        .slot.preferred::before { content: "‚≠ê PREFERRED"; display: block; color: #ff6b6b;
                                 font-weight: bold; margin-bottom: 5px; }
        .slot-venue { font-weight: bold; color: #667eea; font-size: 1.1em; margin-bottom: 5px; }
        .slot-detail { color: #555; margin: 3px 0; }
        .slot-time { font-size: 1.2em; font-weight: bold; color: #333; }
        .slot-actions { margin-top: 10px; }
        .book-btn { background: #28a745; color: white; border: none; padding: 8px 20px;
                   border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer;
                   transition: background 0.3s; }
        .book-btn:hover { background: #218838; }
        .book-btn:disabled { background: #ccc; cursor: not-allowed; }
        .success { background: #d4edda; color: #155724; padding: 15px; border-radius: 8px;
                  border-left: 4px solid #28a745; margin-bottom: 20px; display: none; }
        .error { background: #fee; color: #c00; padding: 15px; border-radius: 8px;
                border-left: 4px solid #c00; margin-bottom: 20px; display: none; }
        @media (max-width: 768px) {
            .header h1 { font-size: 1.8em; }
            .search-box, .results { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="user-menu">
                <span class="user-email" id="userEmail"></span>
                <a href="/auth/logout" class="logout-btn">Logout</a>
            </div>
            <h1>üéæ Tennis Court Finder</h1>
            <p>Find available tennis courts in Vienna</p>
        </div>

        <div class="search-box">
            <div class="input-group">
                <input type="text" id="timeframe" placeholder='Try: "tomorrow at 17:00" or "7.1.2026 between 15:00 and 18:00"'>
                <button onclick="search()">Search</button>
            </div>
            <div class="examples">
                Examples: "next Monday 6-8pm" ‚Ä¢ "at 17:00" ‚Ä¢ "between 15:00 and 18:00"
            </div>
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                <div style="margin-bottom: 10px;">
                    <label style="font-weight: 500; color: #333; margin-bottom: 8px; display: block;">Search for:</label>
                    <div style="display: inline-flex; background: #f0f0f0; border-radius: 8px; padding: 4px;">
                        <button type="button" id="searchModeCourt" onclick="setSearchMode('court')"
                                style="padding: 10px 30px; border: none; border-radius: 6px; background: #667eea; color: white; font-weight: 500; cursor: pointer; transition: all 0.3s;">
                            Court
                        </button>
                        <button type="button" id="searchModeTrainer" onclick="setSearchMode('trainer')"
                                style="padding: 10px 30px; border: none; border-radius: 6px; background: transparent; color: #666; font-weight: 500; cursor: pointer; transition: all 0.3s;">
                            Trainer
                        </button>
                    </div>
                </div>
                <div id="locationSelector" style="margin-top: 15px;">
                    <label style="font-weight: 500; color: #333; margin-bottom: 8px; display: block;">Locations:</label>
                    <div style="display: flex; gap: 15px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="locationArsenal" value="arsenal" checked
                                   style="width: 18px; height: 18px; margin-right: 8px; cursor: pointer;">
                            <span style="color: #555;">Arsenal (Das Spiel)</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="locationPostSV" value="postsv" checked
                                   style="width: 18px; height: 18px; margin-right: 8px; cursor: pointer;">
                            <span style="color: #555;">Post SV Wien</span>
                        </label>
                    </div>
                </div>
                <div id="trainerNameField" style="display: none;">
                    <input type="text" id="trainerName" placeholder="Trainer name (optional)" style="width: 100%;">
                </div>
            </div>
        </div>

        <div class="loading" id="loading">
            <h3>üîç Searching courts...</h3>
            <p>This may take up to 60 seconds</p>
        </div>

        <div class="success" id="success"></div>
        <div class="error" id="error"></div>

        <div class="results" id="results">
            <div class="result-header">
                <h2>Available Courts</h2>
                <div class="result-info" id="result-info"></div>
            </div>
            <div id="slots"></div>
        </div>
    </div>

    <script>
        // Check authentication status on page load
        async function checkAuth() {
            try {
                const response = await fetch('/auth/status');
                const data = await response.json();

                if (!response.ok || !data.authenticated) {
                    window.location.href = '/auth/login';
                    return;
                }

                // Display user email
                if (data.user && data.user.email) {
                    document.getElementById('userEmail').textContent = data.user.email;
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/auth/login';
            }
        }

        // Run auth check on page load
        checkAuth();

        // Track current search mode (default: 'court')
        let searchMode = 'court';

        // Function to set search mode and update UI
        function setSearchMode(mode) {
            searchMode = mode;
            const courtBtn = document.getElementById('searchModeCourt');
            const trainerBtn = document.getElementById('searchModeTrainer');
            const trainerNameField = document.getElementById('trainerNameField');
            const locationSelector = document.getElementById('locationSelector');

            if (mode === 'court') {
                courtBtn.style.background = '#667eea';
                courtBtn.style.color = 'white';
                trainerBtn.style.background = 'transparent';
                trainerBtn.style.color = '#666';
                trainerNameField.style.display = 'none';
                locationSelector.style.display = 'block';
            } else {
                courtBtn.style.background = 'transparent';
                courtBtn.style.color = '#666';
                trainerBtn.style.background = '#667eea';
                trainerBtn.style.color = 'white';
                trainerNameField.style.display = 'block';
                locationSelector.style.display = 'none';
            }
        }

        // Normalize input text to handle mobile keyboard variations
        function normalizeInput(text) {
            // Replace smart/curly quotes with straight quotes
            text = text.replace(/[""]/g, '"');  // Curly double quotes
            text = text.replace(/['']/g, "'");  // Curly single quotes
            text = text.replace(/[‚Äû"]/g, '"');  // German quotes

            // Replace various dash characters with standard hyphen
            text = text.replace(/[‚Äì‚Äî‚àí]/g, '-');  // En dash, em dash, minus sign

            // Replace non-breaking spaces with regular spaces
            text = text.replace(/[\u00A0\u202F]/g, ' ');

            // Normalize multiple spaces to single space
            text = text.replace(/\s+/g, ' ');

            return text;
        }

        async function search() {
            let timeframe = document.getElementById('timeframe').value.trim();
            if (!timeframe) {
                document.getElementById('error').textContent = 'Please enter a timeframe';
                document.getElementById('error').style.display = 'block';
                return;
            }

            // Normalize input for mobile compatibility
            timeframe = normalizeInput(timeframe);

            const trainerName = document.getElementById('trainerName').value.trim();

            // Show loading, hide results/errors
            const loadingEl = document.getElementById('loading');
            loadingEl.innerHTML = searchMode === 'court'
                ? '<h3>üîç Searching courts...</h3><p>This may take up to 60 seconds</p>'
                : '<h3>üîç Searching trainers...</h3><p>This may take up to 60 seconds</p>';
            loadingEl.style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.querySelector('button').disabled = true;

            try {
                const requestData = {
                    timeframe,
                    searchMode: searchMode
                };
                if (searchMode === 'trainer' && trainerName) {
                    requestData.trainerName = trainerName;
                }

                // Get selected locations for court search
                if (searchMode === 'court') {
                    const arsenalChecked = document.getElementById('locationArsenal').checked;
                    const postsvChecked = document.getElementById('locationPostSV').checked;
                    requestData.locations = {
                        arsenal: arsenalChecked,
                        postsv: postsvChecked
                    };
                }

                const response = await fetch('search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Search failed');
                }

                displayResults(data);
            } catch (error) {
                document.getElementById('error').textContent = error.message;
                document.getElementById('error').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.querySelector('button').disabled = false;
            }
        }

        // Store slots data globally for booking
        let currentSlots = [];

        function displayResults(data) {
            const resultHeader = document.querySelector('.result-header h2');
            const info = `${data.total} slot(s) found for ${data.timeframe.day}, ${data.timeframe.date} (${data.timeframe.start} - ${data.timeframe.end})`;
            document.getElementById('result-info').textContent = info;

            // Clear any previous results
            document.getElementById('slots').innerHTML = '';

            // Display based on search mode
            if (data.searchMode === 'trainer') {
                // Show trainer results only
                resultHeader.textContent = 'Available Trainers';

                if (data.trainers && data.trainers.length > 0) {
                    document.getElementById('slots').innerHTML = generateTrainerSlots(data.trainers);
                } else {
                    document.getElementById('slots').innerHTML = '<p>No trainers available</p>';
                }
            } else {
                // Show court results only (default)
                resultHeader.textContent = 'Available Courts';

                // Store slots for access by booking function
                currentSlots = data.slots;

                const slotsHtml = data.slots.map((slot, idx) => {
                    const preferred = idx === data.preferred_index ? 'preferred' : '';
                    return `
                        <div class="slot ${preferred}">
                            <div class="slot-venue">${slot.venue}</div>
                            <div class="slot-time">‚è∞ ${slot.time}</div>
                            <div class="slot-detail">üìç ${slot.court_name}</div>
                            <div class="slot-detail">üìÖ ${slot.date} (${slot.day_of_week})</div>
                            <div class="slot-detail">üí∞ ${slot.price}</div>
                            <div class="slot-detail">üìç ${slot.location}</div>
                            <div class="slot-actions">
                                <button class="book-btn" onclick="bookSlotByIndex(${idx})">Book This Court</button>
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('slots').innerHTML = slotsHtml || '<p>No courts available</p>';
            }

            document.getElementById('results').style.display = 'block';
        }

        function generateTrainerSlots(trainers) {
            return trainers.map(trainer => `
                <div class="slot" style="background: #e8f5e9; border-left-color: #4caf50;">
                    <div class="slot-venue">üë®‚Äçüè´ Trainer Session</div>
                    <div class="slot-time">‚è∞ ${trainer.time_start} - ${trainer.time_end}</div>
                    <div class="slot-detail">üí∞ ‚Ç¨${trainer.price}</div>
                    <div class="slot-detail">üìç ${trainer.court_name}</div>
                    <div class="slot-detail">üìÖ ${trainer.date}</div>
                    <div class="slot-detail" style="margin-top: 10px; font-weight: 500;">Available trainers:</div>
                    <div style="margin-left: 20px;">
                        ${trainer.trainers.map(t => `
                            <div style="margin: 5px 0;">
                                ‚úì ${t.name}
                                ${t.training_types ? ` (Types: ${t.training_types.join(', ')})` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function bookSlotByIndex(index) {
            // Get slot from stored data by index
            const slot = currentSlots[index];
            if (!slot) {
                alert('Slot data not found');
                return;
            }
            bookSlot(slot);
        }

        async function bookSlot(slot) {
            // Confirm booking
            const confirmMsg = `Book ${slot.court_name} on ${slot.date} at ${slot.time}?`;
            if (!confirm(confirmMsg)) return;

            // Hide previous messages
            document.getElementById('success').style.display = 'none';
            document.getElementById('error').style.display = 'none';

            // Disable all booking buttons
            document.querySelectorAll('.book-btn').forEach(btn => btn.disabled = true);

            try {
                const response = await fetch('book', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ slot })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Booking failed');
                }

                // Show success message
                const successMsg = `‚úì ${data.message}`;
                document.getElementById('success').textContent = successMsg;
                document.getElementById('success').style.display = 'block';

                // Scroll to success message
                document.getElementById('success').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                document.getElementById('error').textContent = `‚úó ${error.message}`;
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').scrollIntoView({ behavior: 'smooth' });
            } finally {
                // Re-enable booking buttons
                document.querySelectorAll('.book-btn').forEach(btn => btn.disabled = false);
            }
        }

        // Enter key to search
        document.getElementById('timeframe').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') search();
        });
    </script>
</body>
</html>
